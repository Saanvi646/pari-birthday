{% extends 'base.html' %}

{% block content %}

<style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500&display=swap');

    .font-display {
        font-family: 'Playfair Display', serif;
    }

    .font-body {
        font-family: 'Inter', sans-serif;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .vinyl-spin {
        animation: spin 8s linear infinite;
    }

    .vinyl-spin:hover,
    .vinyl-container:hover .vinyl-spin,
    .playing .vinyl-spin {
        animation-play-state: paused;
    }
</style>

<div class="mt-8 mb-24 max-w-6xl mx-auto px-4">

    <!-- Header -->
    <div class="flex items-center justify-between mb-16">
        <div class="flex items-center gap-4">
            <a href="{% url 'home' %}"
                class="p-2 rounded-full hover:bg-gray-100 text-gray-400 hover:text-gray-600 transition">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                </svg>
            </a>
            <h1 class="text-4xl md:text-5xl font-hand text-[#2D2A26]">Our Playlist ðŸŽµ</h1>
        </div>

        <a href="{% url 'add_song' %}"
            class="text-sm font-medium hover:text-gray-600 transition uppercase tracking-widest border-b border-gray-300 pb-1">
            Add Song
        </a>
    </div>

    <!-- Music Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-12 row-gap-16">
        {% for song in songs %}
        <div class="song-item group relative flex flex-col items-center" id="song-{{ song.id }}">

            <!-- Edit Button (Top Left) -->
            <a href="{% url 'edit_song' song.id %}"
                class="absolute top-0 left-0 z-20 p-2 text-gray-300 hover:text-blue-400 transition opacity-0 group-hover:opacity-100">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                </svg>
            </a>

            <!-- Delete Button (Top Right of Cell) -->
            <form action="{% url 'delete_song' song.id %}" method="POST" class="absolute top-0 right-0 z-20">
                {% csrf_token %}
                <button type="submit" onclick="return confirm('Remove this song?')"
                    class="p-2 text-gray-300 hover:text-red-400 transition opacity-0 group-hover:opacity-100">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                    </svg>
                </button>
            </form>

            <!-- CD / Vinyl -->
            <div class="vinyl-container relative cursor-pointer mb-6"
                onclick="togglePlayer('player-{{ song.id }}', 'song-{{ song.id }}')">
                <!-- The spinning disc -->
                <div
                    class="w-48 h-48 rounded-full shadow-xl relative overflow-hidden vinyl-spin border-4 border-white bg-gray-100 mx-auto">
                    {% if song.cover_image %}
                    <img src="{{ song.cover_image.url }}" class="w-full h-full object-cover">
                    {% else %}
                    <div class="w-full h-full bg-gradient-to-br from-gray-200 to-gray-400"></div>
                    {% endif %}
                    <!-- Center Hole -->
                    <div
                        class="absolute inset-0 m-auto w-8 h-8 bg-white rounded-full shadow-inner border border-gray-100 flex items-center justify-center">
                        <div class="w-3 h-3 bg-gray-100 rounded-full"></div>
                    </div>
                    <!-- Shine/Reflection effect -->
                    <div class="absolute inset-0 bg-gradient-to-tr from-white/20 to-transparent pointer-events-none">
                    </div>
                </div>

                <!-- Play Icon Overlay -->
                <div
                    class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    <div
                        class="bg-white/90 backdrop-blur-sm p-3 rounded-full shadow-lg scale-90 group-hover:scale-100 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                            class="w-8 h-8 text-gray-800">
                            <path fill-rule="evenodd"
                                d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653Z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Metadata -->
            <div class="text-center w-full px-4">
                <h2 class="text-xl font-display text-gray-900 font-bold truncate">{{ song.title }}</h2>
                <p class="text-gray-500 font-body text-xs mt-1 uppercase tracking-widest truncate">{{ song.artist }}</p>
            </div>

            <!-- Hidden Music Embed -->
            <div id="player-{{ song.id }}" class="hidden w-full mt-6">
                {% if song.get_embed_url %}
                <div class="shadow-lg rounded-xl overflow-hidden border border-gray-100">
                    <iframe allow="autoplay *; encrypted-media *; fullscreen *; clipboard-write" frameborder="0"
                        height="150" style="width:100%;max-width:660px;overflow:hidden;background:transparent;"
                        sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation"
                        src="{{ song.get_embed_url }}"></iframe>
                </div>
                {% else %}
                <p class="text-center text-red-400 text-xs mt-2">Invalid URL</p>
                {% endif %}
            </div>

        </div>
        {% empty %}
        <div class="col-span-full text-center py-20 opacity-50">
            <div class="w-32 h-32 bg-gray-100 rounded-full mx-auto mb-4 border-2 border-dashed border-gray-300"></div>
            <p>No music added yet.</p>
        </div>
        {% endfor %}
    </div>

</div>

<script>
    function togglePlayer(playerId, songId) {
        const player = document.getElementById(playerId);
        const songContainer = document.getElementById(songId);

        // 1. Close all other players first
        document.querySelectorAll('[id^="player-"]').forEach(el => {
            if (el.id !== playerId) {
                el.classList.add('hidden');
                // Remove playing class from other containers
                const parent = el.closest('.song-item');
                if (parent) parent.classList.remove('playing');
            }
        });

        // 2. Toggle this player
        if (player.classList.contains('hidden')) {
            player.classList.remove('hidden');
            songContainer.classList.add('playing');
        } else {
            player.classList.add('hidden');
            songContainer.classList.remove('playing');
        }
    }
</script>

{% endblock %}